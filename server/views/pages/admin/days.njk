{% extends "partials/layout.njk" %}

{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/tabs/macro.njk" import govukTabs %}
{% from "govuk/components/table/macro.njk" import govukTable %}
{% from "partials/admin/translateDay.njk" import translateDay %}

{% set pageTitle = "Time slots for official visits" %}
{% set paramBackTo = ("?backTo=" + b64BackTo) if b64BackTo %}

{% block content %}
  <div class="govuk-grid-row">
    <span class="govuk-hint">Admin</span>
    <h1 class="govuk-heading-l">Time slots for official visits</h1>
    <p class="govuk-body">Setting an end date for all visit times will not effect existing visits scheduled for the time and locations.</p>

    {# Setup the HTML content of the tabbed pane for each day of the week #}
    {% set monTimeSlotsHtml = dayVisitTimes(monSlots, 'Monday', 'MON') %}
    {% set tueTimeSlotsHtml = dayVisitTimes(tueSlots, 'Tuesday', 'TUE') %}
    {% set wedTimeSlotsHtml = dayVisitTimes(wedSlots, 'Wednesday', 'WED') %}
    {% set thuTimeSlotsHtml = dayVisitTimes(thuSlots, 'Thursday', 'THU') %}
    {% set friTimeSlotsHtml = dayVisitTimes(friSlots, 'Friday', 'FRI') %}
    {% set satTimeSlotsHtml = dayVisitTimes(satSlots, 'Saturday', 'SAT') %}
    {% set sunTimeSlotsHtml = dayVisitTimes(sunSlots, 'Sunday', 'SUN') %}

    {# Build tab items only for days that have slots (matches mock showing only populated days) #}
    {% set days = [
      { label: 'Monday', id: 'monday', html: monTimeSlotsHtml, slots: monSlots },
      { label: 'Tuesday', id: 'tuesday', html: tueTimeSlotsHtml, slots: tueSlots },
      { label: 'Wednesday', id: 'wednesday', html: wedTimeSlotsHtml, slots: wedSlots },
      { label: 'Thursday', id: 'thursday', html: thuTimeSlotsHtml, slots: thuSlots },
      { label: 'Friday', id: 'friday', html: friTimeSlotsHtml, slots: friSlots },
      { label: 'Saturday', id: 'saturday', html: satTimeSlotsHtml, slots: satSlots },
      { label: 'Sunday', id: 'sunday', html: sunTimeSlotsHtml, slots: sunSlots }
    ] %}

    {% set items = [] %}
    {% for d in days %}
      {% if d.slots and d.slots.length > 0 %}
        {% set items = (items.push({ label: d.label, id: d.id, panel: { html: d.html } }), items) %}
      {% endif %}
    {% endfor %}

    {{ govukTabs({ items: items }) }}

  </div>
{% endblock %}

{% macro dayVisitTimes(slots, dayLabel, dayCode) %}
  <h2 class="govuk-heading-m">Scheduled visit times</h2>

  {% set rows = [] %}
  {% if slots.length > 0 %}
    {% for slot in slots %}
      {% set manageUrl = '/admin/locations/time-slot/' + slot.timeSlot.prisonTimeSlotId %}
      {% set editUrl = manageUrl + '/edit' %}
      {% set rows = (rows.push([
        { text: slot.timeSlot.startTime },
        { text: slot.timeSlot.endTime },
        { text: slot.timeSlot.effectiveDate | formatDate },
        { text: slot.timeSlot.expiryDate | formatDate },
        { html: '<span class="actions"><a href="' + manageUrl + '">Manage locations</a> <a href="' + editUrl + '">Edit</a></span>' }
      ]), rows) %}
    {% endfor %}
  {% else %}
    {% set rows = (rows.push([
      { text: 'No visit times' },
      { text: '' },
      { text: '' },
      { text: '' },
      { text: '' }
    ]), rows) %}
  {% endif %}

  {{ govukTable({
    head: [
      { text: 'Start time' },
      { text: 'End time' },
      { text: 'Effective from' },
      { text: 'Valid until' },
      { text: 'Actions' }
    ],
    rows: rows
  }) }}

  <div class="govuk-button-group govuk-button-group--spread">
    {{ govukButton({
      text: "Add " ~ dayLabel ~ " time",
      preventDoubleClick: true,
      classes: "govuk-button",
      href: "/admin/locations/time-slot/new?day=" ~ dayCode
    }) }}

    {{ govukButton({
      text: "Set end date for all " ~ dayLabel ~ " visit times",
      preventDoubleClick: true,
      classes: "govuk-button--warning",
      href: "/admin/locations/time-slot/end-date?day=" ~ dayCode
    }) }}
  </div>
{% endmacro %}